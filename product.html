<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
        }

        #form-container {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container mt-3">
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Logo</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText"
                    aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarText">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/category.html">Category</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/product.html">Product</a>
                        </li>
                    </ul>
                    <span class="navbar-text">
                        Quản trị admin
                    </span>
                </div>
            </div>
        </nav>
        <h1>Product Management</h1>
        <button class="btn btn-success" id="load-products">
            Load
        </button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exampleModal">
            Thêm mới +
        </button>
        <div class="row mt-3">
            <div class="col-4">
                <label for="" class="form-label">Tìm kiếm</label>
                <input type="text" id="search-name" class="form-control" placeholder="Tìm kiếm...">
            </div>
            <div class="col-4">
                <label for="" class="form-label">Category</label>
                <select id="category-select" class="form-select" aria-label="Default select example">
                    <option selected disabled>Chọn</option>
                    <option value="1">One</option>
                    <option value="2">Two</option>
                    <option value="3">Three</option>
                </select>
            </div>
            <div class="col-12 mt-3">
                <div class="col-3">
                    <button id="search-btn" class="btn btn-primary">Tìm kiếm</button>
                </div>
            </div>
        </div>
        <!-- Display Product List -->
        <div class="card mt-3">
            <div class="card-body">
                <table class="table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Created Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="product-table">
                        <!-- Dynamic product rows -->
                    </tbody>
                </table>
                <nav aria-label="Page navigation example">
                    <ul class="pagination" id="pagination-links">
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Previous" id="previous-page">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>

                        <!-- <li class="page-item"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li> -->

                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Next" id="next-page">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Thêm mới sản phẩm</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <label for="name">Name:</label>
                        <input class="form-control" type="text" id="name">
                        <br>
                        <label for="price">Price:</label>
                        <input class="form-control" type="number" id="price">
                        <br>
                        <label for="categoryId">Category ID:</label>
                        <input class="form-control" type="number" id="categoryId">
                        <br>
                        <label for="categoryId">Ngày tạo:</label>
                        <input class="form-control" type="date" id="createdDate">
                        <br>
                        <button class="btn btn-primary" type="submit">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Chỉnh sửa sản phẩm</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <label for="name">Name:</label>
                        <input class="form-control" type="text" id="name">
                        <br>
                        <label for="price">Price:</label>
                        <input class="form-control" type="number" id="price">
                        <br>
                        <label for="categoryId">Category ID:</label>
                        <input class="form-control" type="number" id="categoryId">
                        <br>
                        <label for="categoryId">Ngày tạo:</label>
                        <input class="form-control" type="date" id="createdDate">
                        <br>
                        <button class="btn btn-primary" type="submit">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        const API_URL = "http://localhost:5000/api/Product"; // Replace with your actual API URL
        let currentPage = 1;  // Trang hiện tại
        let pageSize = 10;    // Số sản phẩm mỗi trang

        product = [
            {
                id: "1",
                name: "Duy",
                price: 123,
                categoryProductName: "oke",
                createdDate: "1/17/2025"
            }
        ]
        // Load all products
        function loadProducts(page) {
            $.ajax({
                url: `${API_URL}?page=${page}&pageSize=${pageSize}`,
                type: 'GET',
                success: function (response) {
                    const products = response.products;
                    const totalPages = response.totalPages;

                    // Cập nhật bảng sản phẩm
                    $('#product-table').empty();
                    products.forEach(product => {
                        $('#product-table').append(`
                    <tr>
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>${product.price}</td>
                        <td>${product.categoryProductName}</td>
                        <td>${new Date(product.createdDate).toLocaleDateString()}</td>
                    </tr>
                `);
                    });

                    // Cập nhật phân trang
                    updatePagination(totalPages);
                },
                error: function () {
                    alert("Failed to load products.");
                }
            });
        }

        // Hàm cập nhật các nút phân trang
        function updatePagination(totalPages) {
            $('#pagination-links').find('.page-item').not('#previous-page, #next-page').remove();

            for (let i = 1; i <= totalPages; i++) {
                $('#pagination-links').children('#previous-page').before(`
            <li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>
        `);
            }

            // Kiểm tra trang hiện tại để disable nút trước/sau
            if (currentPage === 1) {
                $('#previous-page').parent().addClass('disabled');
            } else {
                $('#previous-page').parent().removeClass('disabled');
            }

            if (currentPage === totalPages) {
                $('#next-page').parent().addClass('disabled');
            } else {
                $('#next-page').parent().removeClass('disabled');
            }
        }

        // Xử lý khi người dùng nhấn vào nút phân trang
        $(document).on('click', '.page-link', function (e) {
            e.preventDefault();
            const page = $(this).data('page');

            if (page) {
                currentPage = page;
                loadProducts(currentPage);
            } else if ($(this).attr('id') === 'previous-page' && currentPage > 1) {
                currentPage--;
                loadProducts(currentPage);
            } else if ($(this).attr('id') === 'next-page') {
                currentPage++;
                loadProducts(currentPage);
            }
        });

        // Load sản phẩm khi trang web được tải
        $(document).ready(function () {
            loadProducts(currentPage);
        });

        // Hàm kiểm tra nếu tên sản phẩm bị trùng
        function isProductNameValid(name) {
            let isValid = true;
            // Kiểm tra trùng tên trong danh sách sản phẩm
            product.forEach(function (item) {
                if (item.name.toLowerCase() === name.toLowerCase()) {
                    isValid = false;
                }
            });
            return isValid;
        }

        // Hàm kiểm tra định dạng ngày
        function isDateValid(date) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            return regex.test(date);
        }
        // Add or Update Product
        // Xử lý khi người dùng nhấn nút Lưu (submit form)
        $('#product-form').submit(function (event) {
            event.preventDefault();

            const name = $('#name').val();
            const price = $('#price').val();
            const categoryId = $('#categoryId').val();
            const createdDate = $('#createdDate').val();  // Thay đổi id của trường ngày nhập nếu cần

            // Kiểm tra tên sản phẩm
            if (!name || !isProductNameValid(name)) {
                alert("Tên sản phẩm không hợp lệ: Tên trống hoặc trùng với sản phẩm đã tồn tại.");
                return;
            }

            // Kiểm tra giá trị ngày nhập
            if (!createdDate || !isDateValid(createdDate)) {
                alert("Ngày nhập không hợp lệ: Vui lòng nhập đúng định dạng ngày.");
                return;
            }

            const productData = {
                id: $('#product-id').val() ? parseInt($('#product-id').val()) : null,
                name: name,
                price: parseFloat(price),
                categoryId: parseInt(categoryId),
                createdDate: createdDate
            };

            // Kiểm tra dữ liệu hợp lệ và thực hiện thêm hoặc cập nhật sản phẩm
            if (productData.id) {
                // Cập nhật sản phẩm
                $.ajax({
                    url: `${API_URL}/${productData.id}`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(productData),
                    success: function () {
                        alert("Cập nhật sản phẩm thành công.");
                        loadProducts(currentPage); // Load lại danh sách sản phẩm
                        resetForm();
                    },
                    error: function () {
                        alert("Cập nhật sản phẩm thất bại.");
                    }
                });
            } else {
                // Thêm mới sản phẩm
                $.ajax({
                    url: API_URL,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(productData),
                    success: function () {
                        alert("Thêm mới sản phẩm thành công.");
                        loadProducts(currentPage); // Load lại danh sách sản phẩm
                        resetForm();
                    },
                    error: function () {
                        alert("Thêm mới sản phẩm thất bại.");
                    }
                });
            }
        });

        // Edit product
        window.editProduct = function (id) {
            $.ajax({
                url: `${API_URL}/${id}`,
                type: 'GET',
                success: function (product) {
                    $('#form-title').text("Edit Product");
                    $('#product-id').val(product.id);
                    $('#name').val(product.name);
                    $('#price').val(product.price);
                    $('#categoryId').val(product.categoryId);
                },
                error: function () {
                    alert("Failed to fetch product.");
                }
            });
        };

        // Delete product
        window.deleteProduct = function (id) {
            if (confirm("Are you sure you want to delete this product?")) {
                $.ajax({
                    url: `${API_URL}/${id}`,
                    type: 'DELETE',
                    success: function () {
                        alert("Product deleted successfully.");
                        $('#load-products').click();
                    },
                    error: function () {
                        alert("Failed to delete product.");
                    }
                });
            }
        };

        // Reset form
        function resetForm() {
            $('#form-title').text("Add Product");
            $('#product-id').val("");
            $('#name').val("");
            $('#price').val("");
            $('#categoryId').val("");
        }
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>